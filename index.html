<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Escolar Interativo</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ESTILO GERAL */
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Roxo Moderno */
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Impede scroll durante as perguntas */
        }

        /* O CONTAINER PRINCIPAL (CENTRALIZADO) */
        #main-container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            text-align: center;
            color: white;
            transition: all 0.5s ease;
        }

        /* ANIMA√á√ïES DE TRANSI√á√ÉO */
        .question-box {
            display: none; /* Escondido por padr√£o */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .question-box.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .question-box.leaving {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none; /* Impede clique duplo */
        }

        /* TIPOGRAFIA */
        h1 { font-size: 2rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        h2 { font-size: 1.5rem; margin-bottom: 30px; font-weight: 400; }
        
        /* BOT√ïES DE OP√á√ÉO (CARD BIG BUTTONS) */
        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .option-card:hover {
            background: white;
            color: #764ba2;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .option-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: rgba(0,0,0,0.1);
        }

        /* INPUTS TEXTO */
        input[type="number"], input[type="text"] {
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: none;
            width: 70%;
            text-align: center;
            margin-bottom: 20px;
            outline: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-next {
            background: #ffecd2;
            color: #333;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-next:hover { background: #fff; transform: translateY(-2px); }

        /* TELA DE RESULTADO (MODO CLARO) */
        #result-screen {
            display: none;
            background: white;
            color: #333;
            position: absolute;
            top: 0; left: 0; width: 100%; min-height: 100vh;
            overflow-y: auto; /* Permite scroll no resultado */
            padding: 20px;
            box-sizing: border-box;
        }

        .child-result {
            background: #f7fafc;
            border-left: 5px solid #764ba2;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #mapa { height: 400px; width: 100%; border-radius: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="main-container">

        <div id="q1" class="question-box active">
            <h1>üëã Ol√°!</h1>
            <h2>Quantas crian√ßas precisam de escola hoje?</h2>
            <input type="number" id="inputQtd" min="1" max="5" value="1">
            <br>
            <button class="btn-next" onclick="nextStep('q1')">Continuar ‚ûî</button>
        </div>

        <div id="q-config-intro" class="question-box">
            <h1>üßí Crian√ßa <span id="lbl-filho-num">1</span></h1>
            <h2>Qual tipo de escola voc√™ busca?</h2>
            <div class="options-grid">
                <div class="option-card" onclick="setFilhoConfig('tipo', 'publica')">üèõÔ∏è P√∫blica (Gratuita)</div>
                <div class="option-card" onclick="setFilhoConfig('tipo', 'particular')">üíé Particular</div>
            </div>
        </div>

        <div id="q-config-nivel" class="question-box">
            <h1>üìö Crian√ßa <span id="lbl-filho-num-2">1</span></h1>
            <h2>Qual √© o n√≠vel escolar?</h2>
            <div class="options-grid">
                <div class="option-card" onclick="setFilhoConfig('nivel', 'fundamental')">üéí Fundamental (6-14 anos)</div>
                <div class="option-card" onclick="setFilhoConfig('nivel', 'medio')">üéì M√©dio (15-17 anos)</div>
            </div>
        </div>

        <div id="q-config-transporte" class="question-box">
            <h1>üöå Crian√ßa <span id="lbl-filho-num-3">1</span></h1>
            <h2>Como ser√° o transporte?</h2>
            <div class="options-grid">
                <div class="option-card" onclick="setFilhoConfig('transporte', 'car')">üöó Carro (Pais levam)</div>
                <div class="option-card" onclick="setFilhoConfig('transporte', 'foot')">üö∂ A p√© (Caminhando)</div>
                <div class="option-card disabled" onclick="alert('Sistema de √¥nibus indispon√≠vel no momento.')">üöå √înibus (Indispon√≠vel)</div>
            </div>
        </div>

        <div id="q-cep" class="question-box">
            <h1>üìç Quase l√°...</h1>
            <h2>Qual o CEP da sua resid√™ncia?</h2>
            <input type="text" id="inputCep" placeholder="Ex: 71691100" maxlength="9">
            <br>
            
            <div id="div-mesma-escola" style="display:none; margin-bottom: 15px;">
                <label style="cursor:pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="checkMesma"> Tentar colocar todos na mesma escola?
                </label>
            </div>

            <button class="btn-next" onclick="finalizar()">Ver Resultados üèÅ</button>
            <p id="loading-msg" style="display:none; font-size: 0.8rem; margin-top:10px;">üì° Consultando sat√©lites...</p>
        </div>

    </div>

    <div id="result-screen">
        <h1 style="color:#764ba2; text-align: center;">Planejamento Escolar</h1>
        <div id="results-container"></div>
        <div id="mapa"></div>
        <br>
        <button class="btn-next" style="background:#764ba2; color:white; width:100%" onclick="location.reload()">üîÑ Recome√ßar</button>
    </div>

<script>
    // --- BANCO DE DADOS ---
    const escolasDB = [
        { id: 1, nome: "CEM 01 (Centr√£o)", lat: -15.9015374, lng: -47.7794402, type: 'publica', levels: ['medio'] },
        { id: 2, nome: "CEF S√£o Jos√©", lat: -15.9039391, lng: -47.7783892, type: 'publica', levels: ['fundamental'] },
        { id: 3, nome: "Escola Classe Agrovila", lat: -15.9000604, lng: -47.7719123, type: 'publica', levels: ['fundamental'] },
        { id: 4, nome: "Col√©gio Modelo", lat: -15.9038388, lng: -47.7619481, type: 'particular', levels: ['fundamental', 'medio'] },
        { id: 5, nome: "Escola Master", lat: -15.9077383, lng: -47.7619034, type: 'particular', levels: ['fundamental', 'medio'] },
        { id: 6, nome: "CED S√£o Bartolomeu", lat: -15.915, lng: -47.765, type: 'publica', levels: ['fundamental', 'medio'] } 
    ];

    // --- ESTADO DO APP ---
    let totalFilhos = 1;
    let filhoAtual = 1;
    let dadosFilhos = [];
    let configTemp = {}; 

    // --- FUN√á√ïES DE TRANSI√á√ÉO (SURGE E SUMA) ---
    function switchScreen(idSai, idEntra) {
        const divSai = document.getElementById(idSai);
        const divEntra = document.getElementById(idEntra);

        // Anima√ß√£o de sa√≠da
        divSai.classList.add('leaving');
        divSai.classList.remove('active');

        // Espera anima√ß√£o acabar (500ms) para mostrar o pr√≥ximo
        setTimeout(() => {
            divSai.style.display = 'none'; // Some de vez
            
            // Prepara o pr√≥ximo (reseta anima√ß√£o)
            divEntra.style.display = 'block';
            divEntra.classList.remove('leaving');
            
            // Pequeno delay para o browser renderizar e animar a entrada
            setTimeout(() => {
                divEntra.classList.add('active');
            }, 50);

        }, 500);
    }

    // --- L√ìGICA DO FLUXO ---

    function nextStep(currentId) {
        if (currentId === 'q1') {
            totalFilhos = parseInt(document.getElementById('inputQtd').value);
            if(totalFilhos < 1) totalFilhos = 1;
            
            filhoAtual = 1;
            dadosFilhos = [];
            atualizarLabelsFilho();
            switchScreen('q1', 'q-config-intro');
        }
    }

    function atualizarLabelsFilho() {
        document.getElementById('lbl-filho-num').innerText = filhoAtual;
        document.getElementById('lbl-filho-num-2').innerText = filhoAtual;
        document.getElementById('lbl-filho-num-3').innerText = filhoAtual;
    }

    function setFilhoConfig(chave, valor) {
        configTemp[chave] = valor;

        // L√≥gica de avan√ßo autom√°tico
        if (chave === 'tipo') {
            switchScreen('q-config-intro', 'q-config-nivel');
        } 
        else if (chave === 'nivel') {
            switchScreen('q-config-nivel', 'q-config-transporte');
        } 
        else if (chave === 'transporte') {
            // Salvou o filho atual
            configTemp.id = filhoAtual;
            dadosFilhos.push({...configTemp}); // Salva c√≥pia
            configTemp = {}; // Limpa temp

            // Verifica se tem mais filhos
            if (filhoAtual < totalFilhos) {
                filhoAtual++;
                atualizarLabelsFilho();
                // Volta para o inicio do loop de config (efeito visual de reset)
                switchScreen('q-config-transporte', 'q-config-intro');
            } else {
                // Acabou, vai para o CEP
                if (totalFilhos > 1) document.getElementById('div-mesma-escola').style.display = 'block';
                switchScreen('q-config-transporte', 'q-cep');
            }
        }
    }

    // --- FINALIZA√á√ÉO ---
    async function finalizar() {
        const cep = document.getElementById('inputCep').value.replace(/\D/g, '');
        if (cep.length !== 8) { alert('CEP inv√°lido'); return; }

        document.getElementById('loading-msg').style.display = 'block';

        try {
            const coords = await obterLatLon(cep);
            processarResultados(coords.lat, coords.lon);
        } catch (e) {
            alert("Erro ao buscar CEP. Verifique e tente novamente.");
            document.getElementById('loading-msg').style.display = 'none';
        }
    }

    async function obterLatLon(cep) {
        try {
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=Brazil+${cep}&limit=1`);
            const d = await r.json();
            if (d.length > 0) return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon) };
        } catch(e) {}
        const r2 = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
        const d2 = await r2.json();
        return { lat: d2.location.coordinates.latitude, lon: d2.location.coordinates.longitude };
    }

    // --- RENDERIZAR RESULTADO ---
    function processarResultados(latUser, lngUser) {
        const checkMesma = document.getElementById('checkMesma').checked;
        const container = document.getElementById('results-container');
        container.innerHTML = '';

        // Processa listas
        let listaFinal = [];
        
        dadosFilhos.forEach(filho => {
            let candidatas = escolasDB.filter(e => e.type === filho.tipo && e.levels.includes(filho.nivel));
            candidatas = candidatas.map(e => ({...e, dist: getDistancia(latUser, lngUser, e.lat, e.lng)}));
            candidatas.sort((a,b) => a.dist - b.dist);
            
            listaFinal.push({ filho: filho, opcoes: candidatas });
        });

        // L√≥gica Mesma Escola
        let escolaComum = null;
        let conflito = false;
        if (checkMesma && totalFilhos > 1) {
            let ids = listaFinal[0].opcoes.map(e => e.id);
            for(let i=1; i<listaFinal.length; i++) {
                let idsOutro = listaFinal[i].opcoes.map(e => e.id);
                ids = ids.filter(id => idsOutro.includes(id));
            }
            if(ids.length > 0) escolaComum = escolasDB.find(e => e.id === ids[0]);
            else conflito = true;
        }

        // Renderiza HTML
        if (conflito) container.innerHTML += `<div style="padding:10px; background:#ffd1d1; color:#c53030; border-radius:5px; margin-bottom:10px;">‚ö†Ô∏è N√£o existe escola √∫nica para as op√ß√µes selecionadas. Mostrando individuais.</div>`;

        // Prepara Mapa
        document.getElementById('result-screen').style.display = 'block';
        const mapa = L.map('mapa').setView([latUser, lngUser], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
        const layerGroup = L.layerGroup().addTo(mapa);

        // Pino Casa
        L.marker([latUser, lngUser]).addTo(layerGroup).bindPopup("Sua Casa").openPopup();

        // Loop Visualiza√ß√£o
        listaFinal.forEach(item => {
            let escolha = (escolaComum && !conflito) ? escolaComum : item.opcoes[0];

            if(!escolha) {
                container.innerHTML += `<div class="child-result"><strong>Crian√ßa ${item.filho.id}:</strong> Nenhuma escola encontrada.</div>`;
                return;
            }

            let divId = `rota-${item.filho.id}`;
            let html = `
                <div class="child-result">
                    <h3>üë∂ Crian√ßa ${item.filho.id} <small>(${item.filho.nivel})</small></h3>
                    <strong>Escola:</strong> ${escolha.nome}<br>
                    <div id="${divId}">Calculando...</div>
                </div>
            `;
            container.innerHTML += html;

            // Adiciona no mapa
            L.marker([escolha.lat, escolha.lng]).addTo(layerGroup).bindPopup(escolha.nome);
            L.polyline([[latUser, lngUser], [escolha.lat, escolha.lng]], {color:'blue', dashArray:'5,5'}).addTo(layerGroup);

            // Calcula Tempo
            calcularRota(latUser, lngUser, escolha, item.filho.transporte, divId);
        });
    }

    function getDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const a = Math.sin((lat2-lat1)*Math.PI/360)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin((lon2-lon1)*Math.PI/360)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function calcularRota(lat, lng, escola, modo, divId) {
        const el = document.getElementById(divId);
        const profile = modo === 'foot' ? 'walking' : 'driving';
        
        fetch(`https://router.project-osrm.org/route/v1/${profile}/${lng},${lat};${escola.lng},${escola.lat}?overview=false`)
        .then(r => r.json())
        .then(d => {
            if(d.routes && d.routes.length) {
                let min = Math.round(d.routes[0].duration / 60);
                el.innerHTML = `‚è±Ô∏è <strong>${min} min</strong> (${modo === 'foot' ? 'Andando' : 'Carro'})`;
            } else {
                el.innerHTML = "Tempo indispon√≠vel.";
            }
        });
    }

</script>

</body>
</html>
