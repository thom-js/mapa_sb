<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Escolar S√£o Sebasti√£o</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO GERAL --- */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #eef2f3 0%, #8e9eab 100%); /* Cinza Met√°lico Neutro */
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #2d3748;
        }

        /* --- RODAP√â FIXO --- */
        .footer-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 10px;
            text-align: center;
            font-size: 0.75rem;
            color: #718096;
            border-top: 1px solid #cbd5e0;
            z-index: 1000;
        }

        /* --- √ÅREA CENTRAL (SCROLL√ÅVEL SE PRECISAR) --- */
        #main-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 50px; /* Espa√ßo pro rodap√© */
            overflow-y: auto;
            width: 100%;
        }

        #content-box {
            width: 100%;
            max-width: 650px;
            padding: 30px;
            text-align: center;
            transition: all 0.4s ease;
        }

        /* --- CAIXAS DE PERGUNTA --- */
        .question-box {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .question-box.active { display: block; opacity: 1; transform: translateY(0); }
        .question-box.leaving { opacity: 0; transform: translateY(-10px); pointer-events: none; }

        /* TIPOGRAFIA */
        h1 { font-size: 1.8rem; margin-bottom: 10px; color: #1a202c; font-weight: 700; }
        h2 { font-size: 1.25rem; margin-bottom: 25px; color: #4a5568; font-weight: 400; }
        p.intro { font-size: 0.95rem; color: #718096; margin-bottom: 30px; line-height: 1.5; }

        /* --- BOT√ïES DE OP√á√ÉO --- */
        .options-grid { display: flex; flex-direction: column; gap: 12px; }

        .option-card {
            background: white;
            border: 1px solid #cbd5e0;
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .option-card:hover {
            border-color: #3182ce;
            background: #ebf8ff;
            color: #2b6cb0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .option-card.disabled {
            background: #f7fafc; color: #a0aec0; border-color: #e2e8f0;
            cursor: not-allowed; pointer-events: none;
        }
        
        /* INPUTS */
        input {
            padding: 15px; font-size: 1.1rem; border-radius: 8px;
            border: 2px solid #cbd5e0; width: 60%; text-align: center;
            outline: none; transition: 0.3s;
        }
        input:focus { border-color: #3182ce; }

        /* BOT√ïES DE A√á√ÉO */
        .btn-nav {
            padding: 12px 30px; border-radius: 30px; font-size: 1rem; font-weight: bold;
            cursor: pointer; border: none; transition: 0.3s; margin-top: 20px;
        }
        .btn-next { background: #3182ce; color: white; }
        .btn-next:hover { background: #2c5282; transform: translateY(-2px); }
        
        .btn-back {
            background: transparent; color: #718096; border: 1px solid #cbd5e0;
            margin-right: 10px; font-size: 0.9rem; padding: 10px 20px;
        }
        .btn-back:hover { background: #e2e8f0; color: #2d3748; }

        /* --- TELA DE RESULTADO --- */
        #result-screen {
            display: none;
            background: #f7fafc;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 20px; box-sizing: border-box;
            z-index: 500; padding-bottom: 60px;
        }

        .result-header { text-align: center; margin-bottom: 20px; }
        
        .child-result {
            background: white; border-radius: 10px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 5px solid #3182ce;
        }

        .data-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
            font-size: 0.9rem;
        }
        .data-item { background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .data-label { font-size: 0.75rem; color: #718096; display: block; }
        .data-value { font-weight: bold; color: #2d3748; }

        #mapa { height: 350px; width: 100%; border-radius: 10px; margin-top: 20px; border: 1px solid #cbd5e0; }
        
        .loading { font-style: italic; color: #718096; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="main-wrapper">
        <div id="content-box">

            <div id="q1" class="question-box active">
                <h1>Planejador Escolar</h1>
                <p class="intro">
                    Este sistema (prot√≥tipo) visa encontrar a escola mais perto para sua fam√≠lia, 
                    baseado em crit√©rios pedag√≥gicos e na dist√¢ncia real (via p√∫blica) calculada a partir do seu CEP.
                </p>
                <h2>Quantas crian√ßas estudar√£o?</h2>
                <input type="number" id="inputQtd" min="1" max="5" value="1">
                <br>
                <button class="btn-nav btn-next" onclick="startFlow()">Iniciar</button>
            </div>

            <div id="tpl-tipo" class="question-box">
                <h1>Crian√ßa <span class="lbl-num">1</span></h1>
                <h2>Prefer√™ncia de Escola:</h2>
                <div class="options-grid">
                    <div class="option-card" onclick="saveConfig('tipo', 'publica')">P√∫blica</div>
                    <div class="option-card" onclick="saveConfig('tipo', 'particular')">Particular</div>
                    <div class="option-card" onclick="saveConfig('tipo', 'ambos')">N√£o importa</div>
                </div>
                <button class="btn-nav btn-back" onclick="goBack()">Voltar</button>
            </div>

            <div id="tpl-nivel" class="question-box">
                <h1>Crian√ßa <span class="lbl-num">1</span></h1>
                <h2>N√≠vel de Ensino:</h2>
                <div class="options-grid">
                    <div class="option-card" onclick="saveConfig('nivel', 'fundamental')">Fundamental (6-14 anos)</div>
                    <div class="option-card" onclick="saveConfig('nivel', 'medio')">M√©dio (15-17 anos)</div>
                </div>
                <button class="btn-nav btn-back" onclick="goBack()">Voltar</button>
            </div>

            <div id="tpl-transporte" class="question-box">
                <h1>Crian√ßa <span class="lbl-num">1</span></h1>
                <h2>Meio de Transporte Principal:</h2>
                <div class="options-grid">
                    <div class="option-card" onclick="saveConfig('transporte', 'car')">Carro</div>
                    <div class="option-card" onclick="saveConfig('transporte', 'foot')">A p√©</div>
                    <div class="option-card disabled">√înibus (Indispon√≠vel no sistema)</div>
                    <div class="option-card disabled">Escolar (Indispon√≠vel no sistema)</div>
                </div>
                <button class="btn-nav btn-back" onclick="goBack()">Voltar</button>
            </div>

            <div id="q-cep" class="question-box">
                <h1>Localiza√ß√£o</h1>
                <h2>Digite o CEP da resid√™ncia:</h2>
                <input type="text" id="inputCep" placeholder="Ex: 71691100" maxlength="9">
                <br>
                <div id="div-mesma-escola" style="margin-top:20px; display:none;">
                    <label style="cursor:pointer; color:#4a5568;">
                        <input type="checkbox" id="checkMesma"> Tentar mesma escola para todos?
                    </label>
                </div>
                <br>
                <button class="btn-nav btn-back" onclick="goBack()">Voltar</button>
                <button class="btn-nav btn-next" onclick="finalizar()">Ver Resultado</button>
                <p id="loading-msg" style="display:none; color:#3182ce; margin-top:15px;">Consultando base de dados...</p>
            </div>

        </div>
    </div>

    <div id="result-screen">
        <div class="result-header">
            <h1>Resultado da An√°lise</h1>
            <p style="color:#718096">Baseado nas rotas reais de S√£o Sebasti√£o</p>
        </div>
        <div id="results-container"></div>
        <div id="mapa"></div>
        <div style="height: 50px;"></div> <br>
        <button class="btn-nav btn-next" style="width:100%; max-width:300px; display:block; margin:0 auto;" onclick="location.reload()">Nova Consulta</button>
    </div>

    <div class="footer-fixed">
        Prot√≥tipo v7.0 ‚Ä¢ Thomas J. Schrage<br>
        APIs: Nominatim (Geocoding) & OSRM (Routing). Elaborado com apoio Gemini 3.0 Pro.
    </div>

<script>
    // --- BANCO DE DADOS ---
    const escolasDB = [
        { id: 1, nome: "CEM 01 (Centr√£o)", lat: -15.9015374, lng: -47.7794402, type: 'publica', levels: ['medio'] },
        { id: 2, nome: "CEF S√£o Jos√©", lat: -15.9039391, lng: -47.7783892, type: 'publica', levels: ['fundamental'] },
        { id: 3, nome: "Escola Classe Agrovila", lat: -15.9000604, lng: -47.7719123, type: 'publica', levels: ['fundamental'] },
        { id: 4, nome: "Col√©gio Modelo", lat: -15.9038388, lng: -47.7619481, type: 'particular', levels: ['fundamental', 'medio'] },
        { id: 5, nome: "Escola Master", lat: -15.9077383, lng: -47.7619034, type: 'particular', levels: ['fundamental', 'medio'] },
        { id: 6, nome: "CED S√£o Bartolomeu", lat: -15.915, lng: -47.765, type: 'publica', levels: ['fundamental', 'medio'] }
    ];

    // --- CONTROLE DE FLUXO ---
    let totalFilhos = 1;
    let filhoAtual = 1;
    let dadosFilhos = [];
    let configTemp = {};
    
    // Hist√≥rico para o bot√£o voltar (Pilha de IDs de tela)
    let historyStack = ['q1']; 

    function navigateTo(nextId) {
        const currentId = historyStack[historyStack.length - 1];
        
        // Esconde atual
        document.getElementById(currentId).classList.remove('active');
        document.getElementById(currentId).classList.add('leaving');

        setTimeout(() => {
            document.getElementById(currentId).style.display = 'none';
            document.getElementById(currentId).classList.remove('leaving');

            // Mostra novo
            const nextEl = document.getElementById(nextId);
            nextEl.style.display = 'block';
            
            // Atualiza labels se for tela de filho
            if(nextId.startsWith('tpl-')) {
                document.querySelectorAll('.lbl-num').forEach(span => span.innerText = filhoAtual);
            }

            setTimeout(() => nextEl.classList.add('active'), 50);
        }, 400);

        historyStack.push(nextId);
    }

    function goBack() {
        if (historyStack.length <= 1) return;
        
        const currentId = historyStack.pop(); // Remove atual
        const prevId = historyStack[historyStack.length - 1]; // Pega o anterior

        // L√≥gica reversa de filhos
        // Se estamos voltando do 'tpl-tipo' (in√≠cio da config de um filho) para 'tpl-transporte' (fim do anterior)
        if (currentId === 'tpl-tipo' && prevId === 'tpl-transporte') {
            filhoAtual--;
            dadosFilhos.pop(); // Remove dados salvos do √∫ltimo filho
        }
        // Se estamos voltando do CEP para Transporte
        else if (currentId === 'q-cep' && prevId === 'tpl-transporte') {
            // N√£o precisa decrementar filho, pois estamos no √∫ltimo ainda, s√≥ reabrindo config
            dadosFilhos.pop(); // Remove o √∫ltimo salvo para reconfigurar
        }

        // Transi√ß√£o visual de volta
        document.getElementById(currentId).classList.remove('active');
        document.getElementById(currentId).style.display = 'none';
        
        const prevEl = document.getElementById(prevId);
        prevEl.style.display = 'block';
        if(prevId.startsWith('tpl-')) {
            document.querySelectorAll('.lbl-num').forEach(span => span.innerText = filhoAtual);
        }
        setTimeout(() => prevEl.classList.add('active'), 50);
    }

    function startFlow() {
        totalFilhos = parseInt(document.getElementById('inputQtd').value);
        if (totalFilhos < 1) totalFilhos = 1;
        filhoAtual = 1;
        dadosFilhos = [];
        navigateTo('tpl-tipo');
    }

    function saveConfig(key, value) {
        configTemp[key] = value;

        if (key === 'tipo') navigateTo('tpl-nivel');
        else if (key === 'nivel') navigateTo('tpl-transporte');
        else if (key === 'transporte') {
            // Fim da config deste filho
            configTemp.id = filhoAtual;
            dadosFilhos.push({...configTemp});
            configTemp = {};

            if (filhoAtual < totalFilhos) {
                filhoAtual++;
                navigateTo('tpl-tipo');
            } else {
                if(totalFilhos > 1) document.getElementById('div-mesma-escola').style.display = 'block';
                navigateTo('q-cep');
            }
        }
    }

    // --- C√ÅLCULO FINAL ---
    async function finalizar() {
        const cep = document.getElementById('inputCep').value.replace(/\D/g, '');
        if (cep.length !== 8) { alert('CEP inv√°lido'); return; }

        document.getElementById('loading-msg').style.display = 'block';

        try {
            const coords = await obterLatLon(cep);
            renderizarResultados(coords.lat, coords.lon);
        } catch (e) {
            alert("Erro ao buscar CEP ou conectar ao servi√ßo.");
            document.getElementById('loading-msg').style.display = 'none';
        }
    }

    async function obterLatLon(cep) {
        try {
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=Brazil+${cep}&limit=1`);
            const d = await r.json();
            if (d.length > 0) return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon) };
        } catch(e) {}
        const r2 = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
        const d2 = await r2.json();
        return { lat: d2.location.coordinates.latitude, lon: d2.location.coordinates.longitude };
    }

    // --- RENDERIZA√á√ÉO COMPLETA DOS DADOS ---
    function renderizarResultados(latUser, lngUser) {
        const checkMesma = document.getElementById('checkMesma').checked;
        const container = document.getElementById('results-container');
        container.innerHTML = '';

        // 1. Filtragem e Ranking Individual
        let listaFinal = [];
        
        dadosFilhos.forEach(filho => {
            // Filtro (Considera 'ambos' no tipo)
            let candidatas = escolasDB.filter(e => {
                const tipoMatch = (filho.tipo === 'ambos') || (e.type === filho.tipo);
                const nivelMatch = e.levels.includes(filho.nivel);
                return tipoMatch && nivelMatch;
            });

            // Ordena√ß√£o (Crit√©rio: Dist√¢ncia Reta para simplicidade inicial)
            candidatas = candidatas.map(e => ({...e, dist: getDistancia(latUser, lngUser, e.lat, e.lng)}));
            candidatas.sort((a,b) => a.dist - b.dist);
            
            listaFinal.push({ filho: filho, opcoes: candidatas });
        });

        // 2. L√≥gica Mesma Escola
        let escolaComum = null;
        let conflito = false;
        if (checkMesma && totalFilhos > 1) {
            let ids = listaFinal[0].opcoes.map(e => e.id);
            for(let i=1; i<listaFinal.length; i++) {
                let idsOutro = listaFinal[i].opcoes.map(e => e.id);
                ids = ids.filter(id => idsOutro.includes(id));
            }
            if(ids.length > 0) escolaComum = escolasDB.find(e => e.id === ids[0]);
            else conflito = true;
        }

        // 3. Montar Interface
        document.getElementById('result-screen').style.display = 'block';
        
        // Mapa init
        const mapa = L.map('mapa').setView([latUser, lngUser], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
        const layerGroup = L.layerGroup().addTo(mapa);
        L.marker([latUser, lngUser]).addTo(layerGroup).bindPopup("Sua Casa").openPopup();

        if (conflito) {
            container.innerHTML += `<div style="padding:15px; background:#fff5f5; color:#c53030; border-radius:8px; margin-bottom:15px; text-align:center;">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> N√£o h√° uma √∫nica escola que atenda todos os crit√©rios selecionados para todos os filhos simultaneamente. Mostrando as melhores op√ß√µes individuais.
            </div>`;
        } else if (escolaComum) {
             container.innerHTML += `<div style="padding:15px; background:#f0fff4; color:#276749; border-radius:8px; margin-bottom:15px; text-align:center;">
                <strong>‚úÖ Sucesso:</strong> Encontramos uma escola comum para todos!
            </div>`;
        }

        // Loop de Renderiza√ß√£o dos Cards
        listaFinal.forEach(item => {
            let escolha = (escolaComum && !conflito) ? escolaComum : item.opcoes[0];

            if(!escolha) {
                container.innerHTML += `<div class="child-result"><strong>Crian√ßa ${item.filho.id}:</strong> Nenhuma escola encontrada.</div>`;
                return;
            }

            // Gera IDs √∫nicos para injetar os dados depois
            const idCar = `car-${item.filho.id}`;
            const idWalk = `walk-${item.filho.id}`;
            const idDist = `dist-${item.filho.id}`;

            const html = `
                <div class="child-result">
                    <h3 style="margin:0; color:#2d3748;">üßí Crian√ßa ${item.filho.id} <small style="font-weight:normal; font-size:0.9rem;">(${item.filho.nivel})</small></h3>
                    <div style="font-size:1.1rem; font-weight:bold; color:#3182ce; margin:5px 0;">${escolha.nome}</div>
                    
                    <div class="data-grid">
                        <div class="data-item">
                            <span class="data-label">Dist√¢ncia Linear</span>
                            <span class="data-value">${getDistancia(latUser, lngUser, escolha.lat, escolha.lng).toFixed(2)} km</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Dist√¢ncia (Via P√∫blica)</span>
                            <span class="data-value" id="${idDist}"><span class="loading">Calc...</span></span>
                        </div>
                        <div class="data-item" style="${item.filho.transporte === 'car' ? 'background:#ebf8ff; border:1px solid #bee3f8;' : ''}">
                            <span class="data-label">Tempo Carro üöó</span>
                            <span class="data-value" id="${idCar}"><span class="loading">Calc...</span></span>
                        </div>
                        <div class="data-item" style="${item.filho.transporte === 'foot' ? 'background:#ebf8ff; border:1px solid #bee3f8;' : ''}">
                            <span class="data-label">Tempo A P√© üö∂</span>
                            <span class="data-value" id="${idWalk}"><span class="loading">Calc...</span></span>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;

            // Desenha no mapa
            L.marker([escolha.lat, escolha.lng]).addTo(layerGroup).bindPopup(escolha.nome);
            
            // Desenha linha (Se transporte escolhido for carro, azul solido, se a p√©, azul pontilhado)
            const estiloLinha = item.filho.transporte === 'car' ? {color:'#3182ce', weight:4} : {color:'#3182ce', dashArray:'5,10', weight:4};
            
            // Tenta desenhar rota real no mapa para a escola escolhida (apenas visual)
            if(!escolaComum || item.filho.id === 1) { // Evita desenhar a mesma linha 3 vezes se for a mesma escola
                 L.Routing.control({
                    waypoints: [L.latLng(latUser, lngUser), L.latLng(escolha.lat, escolha.lng)],
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    lineOptions: { styles: [estiloLinha] },
                    createMarker: function() { return null; },
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
                }).addTo(mapa);
            }

            // --- BUSCA DADOS COMPLETOS (Carro E A p√©) ---
            fetchDadosCompletos(latUser, lngUser, escolha.lat, escolha.lng, idCar, idWalk, idDist);
        });
    }

    // Fun√ß√£o que chama API duas vezes para preencher todos os campos
    function fetchDadosCompletos(lat1, lng1, lat2, lng2, idCar, idWalk, idDist) {
        // 1. Rota de Carro (Driving) - Pega Tempo e Dist√¢ncia Real
        fetch(`https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=false`)
            .then(r => r.json())
            .then(d => {
                if(d.routes && d.routes.length) {
                    const distKm = (d.routes[0].distance / 1000).toFixed(1);
                    const tempoMin = Math.round(d.routes[0].duration / 60);
                    
                    document.getElementById(idDist).innerText = distKm + " km";
                    document.getElementById(idCar).innerText = tempoMin + " min";
                }
            });

        // 2. Rota a P√© (Walking) - Pega Tempo
        fetch(`https://router.project-osrm.org/route/v1/walking/${lng1},${lat1};${lng2},${lat2}?overview=false`)
            .then(r => r.json())
            .then(d => {
                if(d.routes && d.routes.length) {
                    const tempoMin = Math.round(d.routes[0].duration / 60);
                    document.getElementById(idWalk).innerText = tempoMin + " min";
                }
            });
    }

    function getDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const a = Math.sin((lat2-lat1)*Math.PI/360)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin((lon2-lon1)*Math.PI/360)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

</script>

</body>
</html>
